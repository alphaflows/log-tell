[SERVICE]
    Flush        1
    Log_Level    info
    Parsers_File parsers.conf
    storage.path        /fluent-bit/state
    storage.sync        normal
    storage.checksum    On
    storage.backlog.mem_limit ${FLB_STORAGE_TOTAL_LIMIT}

# Tail docker logs
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*-json.log
    Parser            docker
    Tag               logs.docker.*
    Refresh_Interval  5
    Skip_Long_Lines   On
    DB                /fluent-bit/state/docker-containers.db
    DB.Sync           normal
    Mem_Buf_Limit     ${FLB_TAIL_MEM_BUF_LIMIT}
    Path_Key          container_log_path

[INPUT]
    Name      forward
    Listen    0.0.0.0
    Port      ${FLB_FORWARD_PORT}
    Tag       logs.forward.*
    Mem_Buf_Limit ${FLB_TAIL_MEM_BUF_LIMIT}

# Enrich docker tail with container metadata
[FILTER]
    Name            docker
    Match           logs.docker.*
    Docker_Mode     On
    Merge_Log       Off
    Keep_Log        On
    Docker_Mode_Flush 5

# Only keep selected container names/IDs
[FILTER]
    Name    grep
    Match   logs.docker.*
    Regex   container_name ${LOG_CONTAINER_REGEX}

# Stitch stack traces together so alert routing sees full messages
[FILTER]
    Name                multiline
    Match               logs.*
    multiline.key       log
    multiline.parser    stacktrace

# Add hostname
[FILTER]
    Name              record_modifier
    Match             *
    Record            host ${HOSTNAME}

# Only keep lines that match the configured pattern
[FILTER]
    Name   grep
    Match  logs.*
    Regex  log ${LOG_INCLUDE_REGEX}

# Copy error/exception lines to alerts.* tags for dedicated routing
[FILTER]
    Name          rewrite_tag
    Match         logs.*
    Rule          log ${LOG_ALERT_REGEX} alerts.$TAG true
    Emitter_Name  error_router

# Output â†’ OpenObserve
[OUTPUT]
    Name              http
    Match             logs.*
    Host              ${OO_HTTP_HOST}
    Port              ${OO_HTTP_PORT}
    URI               /api/${OO_ORG}/${OO_STREAM_LOGS}/_json
    Format            json
    Json_date_key     timestamp
    Json_date_format  iso8601
    Header            Content-Type application/json
    Header            Authorization ${OO_AUTH_HEADER}
    storage.type      filesystem
    storage.total_limit_size ${FLB_STORAGE_TOTAL_LIMIT}

# Error-only stream for alert queries
[OUTPUT]
    Name              http
    Match             alerts.*
    Host              ${OO_HTTP_HOST}
    Port              ${OO_HTTP_PORT}
    URI               /api/${OO_ORG}/${OO_STREAM_ALERTS}/_json
    Format            json
    Json_date_key     timestamp
    Json_date_format  iso8601
    Header            Content-Type application/json
    Header            Authorization ${OO_AUTH_HEADER}
    storage.type      filesystem
    storage.total_limit_size ${FLB_STORAGE_TOTAL_LIMIT}
